// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "sqlite"
    url      = env("DATABASE_URL")
}

model Player {
    id        Int    @id @default(autoincrement())
    nickname  String @unique
    firstName String
    lastName  String
    avatar    String
    email     String @unique
    wins      Int    @default(0)
    loses     Int    @default(0)

    // explicit self relation many to many
    senders   Friendship[] @relation("SendRequest")
    receivers Friendship[] @relation("ReceiveRequest")
    
    chat_rooms Permission[] @relation("PermissionInRoom")

    all_messages Message[] @relation("SendMsg")
    // explicit relation many to many
}

model ChatRoom {
    id Int    @id @default(autoincrement())
    createdAt  DateTime   @default(now())
    is_dm   Boolean @default(true) // type ==> enum [DM, ROOM]
    name String?
    is_public Boolean @default(true)
    password String?
    all_members Permission[] @relation("PermissionOfmember")
    all_messages Message[] @relation("ThisRoom") // one to many

}

model Permission {
    // statusMember     Status @default(MEMBER)
    statusMember String
    is_banned Boolean @default(false)
    is_muted Boolean @default(false)
    until DateTime

    player     Player   @relation("PermissionInRoom", fields: [playerId], references: [id])
    playerId   Int
    chat_room   ChatRoom   @relation("PermissionOfmember", fields: [roomId], references: [id])
    roomId Int

    @@id([playerId, roomId])
}

model Message {
    id Int @id @default(autoincrement())
    sender Player @relation("SendMsg", fields: [senderId], references: [id])
    senderId Int

    room ChatRoom @relation("ThisRoom", fields: [roomId], references: [id])
    roomId Int

    msg String
    createdAt DateTime @default(now())

}

// There is no enum type in SQLite, only the following:
// enum Status {
//     OWNER
//     ADMIN
//     MEMBER
//     BANNED
// }

// https://www.prisma.io/docs/guides/database/troubleshooting-orm/help-articles/working-with-many-to-many-relations
// https://www.prisma.io/docs/concepts/components/prisma-schema/relations/self-relations#relational-databases

model Friendship {
    status     String
    date       DateTime @default(now())
    sender     Player   @relation("SendRequest", fields: [senderId], references: [id])
    senderId   Int
    receiver   Player   @relation("ReceiveRequest", fields: [receiverId], references: [id])
    receiverId Int

    @@id([senderId, receiverId])
}

